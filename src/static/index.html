<html>
<head>
    <title>A Multiplayer Game</title>
    <style>
        canvas {
            border: 5px solid black;
        }
    </style>

</head>

<body>
    <canvas id="client_canvas" width="920" height="920">
    </canvas>
    <div id="client_status" style="font-family:courier;">
</body>
<script src="/socket.io/socket.io.js"></script>
<script>
    var getRandomColor = function () {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    };
    var Player = function (id) {
        this.playerId = id;
        this.numKills = 0;
        this.moveSpeed = 100;
        this.xPos = 100;
        this.yPos = 100;
        this.color = getRandomColor();
        this.outlineColor = getRandomColor();
    };
    
    Player.prototype.getPlayerId = function () {
        return this.playerId;
    };
    Player.prototype.setPlayerId = function (playerId) {
        this.playerId = playerId;
    };
    Player.prototype.getX = function () {
        return this.xPos;
    };
    Player.prototype.setX = function (x) {
        this.xPos = x;
    };
    Player.prototype.getY = function () {
        return this.yPos;
    };
    Player.prototype.setY = function (y) {
        this.yPos = y;
    };
    Player.prototype.incrementKills = function () {
        this.numKills++;
    };
    Player.prototype.setPositionBuffer = function (positionBuffer) {
        this.positionBuffer = positionBuffer;
    };
    Player.prototype.applyInput = function (input) {
        if (input.movement.up) {
            this.yPos -= input.pressTime * this.moveSpeed;
        }
        if (input.movement.down) {
            this.yPos += input.pressTime * this.moveSpeed;
        }
        if (input.movement.left) {
            this.xPos -= input.pressTime * this.moveSpeed;
        }
        if (input.movement.right) {
            this.xPos += input.pressTime * this.moveSpeed;
        }
    };

    var TICKRATE = 60;
    var Client = function (socket, canvas) {
        this.socket = socket;
        this.playerId = this.socket.id;
        this.player = new Player(this.playerId);
        this.players = {};
        this.players[this.playerId] = this.player;
        this.setUpdateInterval();
        this.moves = [];
        this.lastTS = Date.now();
        this.movement = {};
        this.movement["up"] = false;
        this.movement["down"] = false;
        this.movement["right"] = false;
        this.movement["left"] = false;
        this.savedMoves = [];
        this.serverMessages = [];
        this.canvas = canvas;
    };
    Client.prototype.setUpdateInterval = function () {
        clearInterval(this.updateInterval);
        this.updateInterval = setInterval((function (self) {
            return function () {
                self.updatePositions();
                self.processServerPositions();
                self.repaint();
            };
        })(this), 1000.0 / TICKRATE);
    };
    Client.prototype.addPlayer = function (data) {
        if (data.playerId == this.playerId) {
            return;
        }
        let player = new Player(data.playerId);
        player.setX(data.x);
        player.setY(data.y);

        this.players[data.playerId] = player;
    }
    Client.prototype.removePlayer = function (id) {
        delete this.players[id];

        this.repaint();
    }
    Client.prototype.setPlayers = function (players) {
        for (let key in players) {
            let player = players[key];
            let pid = player.playerId;

            if(pid == this.playerId) {
                continue;
            }

            this.players[pid] = new Player(pid)
            this.players[pid].setX(player.xPos);
            this.players[pid].setY(player.yPos);
        }
    }
    Client.prototype.updatePositions = function () {
        var now = Date.now();
        var lastTS = this.lastTS;
        var pressTime = (now - lastTS) / 1000.0;
        this.lastTS = now;
        var input;
        if (this.movement["up"] || this.movement["down"] || this.movement["left"] || this.movement["right"]) {
            input = { pressTime: pressTime, movement: this.movement, ts: now, id: this.playerId };
        }
        else {
            return;
        }
        this.socket.emit("move", input);
        this.player.applyInput(input);
        this.savedMoves.push(input);
        while (this.savedMoves.length > 30) {
            this.savedMoves.shift();
        }
    };
    Client.prototype.processServerPositions = function () {
        while (this.serverMessages.length > 0) {
            var message = this.serverMessages.shift();
            var pid = message.playerId;
            if (pid == this.playerId) {
                this.updateSelfPosition(message);
            }
            else {
                this.updateOtherPosition(message);
            }
        }
    };
    Client.prototype.updateSelfPosition = function (message) {
        var _this = this;
        var serverTS = message.ts;
        this.player.setX(message.x);
        this.player.setY(message.y);
        this.savedMoves = this.savedMoves.filter(function (savedMove) { savedMove.ts > serverTS; });
        this.savedMoves.forEach(function (savedMove) {
            _this.player.applyInput(savedMove);
        });
    };
    Client.prototype.updateOtherPosition = function (message) {
        if (!this.players[message.playerId]) {
            this.players[message.playerId] = new Player(message.playerId);
        }
        var player = this.players[message.playerId];
        player.setX(message.x);
        player.setY(message.y);
    };
    Client.prototype.repaint = function () {
        this.canvas.width = this.canvas.width;
        for (var key in this.players) {
            var player = this.players[key];
            var radius = 30;
            var x = player.getX();
            var y = player.getY();

            var ctx = this.canvas.getContext("2d");
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, 2 * Math.PI, false);
            ctx.fillStyle = player.color;
            ctx.fill();
            ctx.lineWidth = 5;
            ctx.strokeStyle = player.outlineColor;
            ctx.stroke();
        }
    };

    let element = function (id) {
        return document.getElementById(id);
    };

    // When the player presses the arrow keys, set the corresponding flag in the client.
    var keyHandler = function (e) {
        e = e || window.event;
        if (e.key == 'd') {
            client.movement.right = (e.type == "keydown");
        } else if (e.key == 'a') {
            client.movement.left = (e.type == "keydown");
        } else if (e.key == 'w') {
            client.movement.up = (e.type == "keydown");
        } else if (e.key == 's') {
            client.movement.down = (e.type == "keydown");
        }
    };

    document.body.onkeydown = keyHandler;
    document.body.onkeyup = keyHandler;

    var socket = io.connect();

    var client = null;
    socket.on("connect", () => {
        client = new Client(socket, element("client_canvas"));
    });

    socket.on("curPlayers", function(data) {
        client.setPlayers(data);
    });

    socket.on("newPlayer", function(data) {
        client.addPlayer(data);
    });

    socket.on("removePlayer", function(id) {
        client.removePlayer(id);
    });

    socket.on("gameState", function(data) {
        for (let i = 0; i < data.length; i++) {
            client.serverMessages.push(data[i]);
        }
    });
</script>

</html>